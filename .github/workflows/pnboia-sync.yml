name: PNBOIA Auto Sync

on:
  schedule:
    - cron: '0 */3 * * *'
  workflow_dispatch:

jobs:
  sync-pnboia:
    name: Sync PNBOIA Buoys
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Sync all buoys
        run: |
          echo "Starting PNBOIA sync..."
          echo "Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          
          response=$(curl -X POST \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Content-Type: application/json" \
            -w "\n%{http_code}" \
            -s \
            --max-time 180 \
            "https://${{ secrets.SUPABASE_PROJECT_ID }}.supabase.co/functions/v1/make-server-2d5da22b/pnboia/sync-all?useMock=false")
          
          http_body=$(echo "$response" | head -n -1)
          http_code=$(echo "$response" | tail -n 1)
          
          echo "HTTP Status: $http_code"
          echo "Response: $http_body"
          
          if [ "$http_code" -eq 200 ]; then
            echo "Sync completed successfully!"
            
            success_count=$(echo "$http_body" | grep -o '"success":[0-9]*' | grep -o '[0-9]*' || echo "?")
            total_count=$(echo "$http_body" | grep -o '"total":[0-9]*' | grep -o '[0-9]*' || echo "?")
            
            echo "Result: $success_count/$total_count buoys synced"
          else
            echo "Sync returned status $http_code"
            echo "This can happen if:"
            echo "  - PNBOIA buoys are offline"
            echo "  - Supabase server is slow"
            echo "  - Timeout exceeded"
            echo ""
            echo "Next attempt in 3 hours"
          fi
          
          echo ""
          echo "Next sync: $(date -u -d '+3 hours' '+%Y-%m-%d %H:%M:%S UTC')"

      - name: Check buoy status
        if: success() || failure()
        run: |
          echo ""
          echo "Checking current buoy status..."
          
          status_response=$(curl -X GET \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -w "\n%{http_code}" \
            -s \
            --max-time 30 \
            "https://${{ secrets.SUPABASE_PROJECT_ID }}.supabase.co/functions/v1/make-server-2d5da22b/pnboia/status")
          
          status_body=$(echo "$status_response" | head -n -1)
          status_code=$(echo "$status_response" | tail -n 1)
          
          if [ "$status_code" -eq 200 ]; then
            echo "Status retrieved successfully:"
            echo "$status_body" | python3 -m json.tool 2>/dev/null || echo "$status_body"
            
            active=$(echo "$status_body" | grep -o '"active":[0-9]*' | grep -o '[0-9]*' || echo "0")
            total=$(echo "$status_body" | grep -o '"total":[0-9]*' | grep -o '[0-9]*' || echo "14")
            
            echo ""
            echo "Active buoys: $active/$total"
            
            if [ "$active" -ge 10 ]; then
              echo "Status: Excellent! Most buoys online."
            elif [ "$active" -ge 5 ]; then
              echo "Status: Good! Some buoys offline."
            else
              echo "Status: Degraded! Few buoys online."
            fi
          else
            echo "Could not retrieve status (HTTP $status_code)"
            echo "  System will continue working normally"
          fi

      - name: Summary
        if: always()
        run: |
          echo ""
          echo "========================================================"
          echo "PNBOIA SYNC SUMMARY"
          echo "========================================================"
          echo "Completed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Next run: $(date -u -d '+3 hours' '+%H:%M UTC')"
          echo "Frequency: Every 3 hours (8x per day)"
          echo "========================================================"
          echo ""
          echo "TIPS:"
          echo "  - View logs: GitHub -> Actions -> PNBOIA Auto Sync"
          echo "  - Run manually: Actions -> PNBOIA Auto Sync -> Run workflow"
          echo "  - Pause: Settings -> Actions -> Disable workflow"
          echo ""
