```yaml
name: PNBOIA Auto Sync

===========================================================================
CRON JOB AUTOMATICO - SINCRONIZACAO PNBOIA 24/7
===========================================================================
#
Este workflow garante que as boias PNBOIA sejam sincronizadas SEMPRE,
mesmo quando nao ha usuarios visitando o site.
#
Frequencia: A cada 3 horas (alinhado com atualizacao das boias)
Horarios: 00:00, 03:00, 06:00, 09:00, 12:00, 15:00, 18:00, 21:00 UTC
#
Beneficios:
- Dados sempre frescos (surfista as 6 AM tem dados atualizados)
- Edge Function nunca "dorme"
- Independente de trafego do site
- Resiliente a falhas (tenta novamente em 3h)
#
===========================================================================

on:
  # Executa a cada 3 horas (cron: min hora dia mes dia-da-semana)
  schedule:
cron: '0 */3 * * *'  # A cada 3 horas: 00:00, 03:00, 06:00, etc (UTC)
  
  # Permite execucao manual via GitHub UI (util para testes)
  workflow_dispatch:

jobs:
  sync-pnboia:
    name: Sincronizar Boias PNBOIA
    runs-on: ubuntu-latest
    timeout-minutes: 5  # Timeout de 5 minutos (sincronizacao demora ~1-2 min)
    
    steps:
name: Sincronizar todas as boias
        run: |
          echo "Iniciando sincronizacao PNBOIA..."
          echo "Horario: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          
          # Disparar sincronizacao no servidor
          response=$(curl -X POST \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Content-Type: application/json" \
            -w "\n%{http_code}" \
            -s \
            --max-time 180 \
            "https://${{ secrets.SUPABASE_PROJECT_ID }}.supabase.co/functions/v1/make-server-2d5da22b/pnboia/sync-all?useMock=false")
          
          # Separar body e status code
          http_body=$(echo "$response" | head -n -1)
          http_code=$(echo "$response" | tail -n 1)
          
          echo "Status HTTP: $http_code"
          echo "Resposta: $http_body"
          
          # Verificar sucesso
          if [ "$http_code" -eq 200 ]; then
            echo "Sincronizacao concluida com sucesso!"
            
            # Extrair estatisticas (se possivel)
            success_count=$(echo "$http_body" | grep -o '"success":[0-9]' | grep -o '[0-9]' || echo "?")
            total_count=$(echo "$http_body" | grep -o '"total":[0-9]' | grep -o '[0-9]' || echo "?")
            
            echo "Resultado: $success_count/$total_count boias sincronizadas"
          else
            echo "Sincronizacao retornou status $http_code"
            echo "Isso pode acontecer se:"
            echo "   - Boias PNBOIA estao offline (normal)"
            echo "   - Servidor Supabase esta lento"
            echo "   - Timeout excedido"
            echo ""
            echo "Proxima tentativa em 3 horas"
            
            # Nao falhar o workflow - e normal ter falhas ocasionais
            # O sistema continuara tentando a cada 3 horas
          fi
          
          echo ""
          echo "Proxima sincronizacao: $(date -u -d '+3 hours' '+%Y-%m-%d %H:%M:%S UTC')"

name: Verificar status das boias
        if: success() || failure()  # Sempre executar, mesmo se passo anterior falhar
        run: |
          echo ""
          echo "Verificando status atual das boias..."
          
          status_response=$(curl -X GET \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -w "\n%{http_code}" \
            -s \
            --max-time 30 \
            "https://${{ secrets.SUPABASE_PROJECT_ID }}.supabase.co/functions/v1/make-server-2d5da22b/pnboia/status")
          
          status_body=$(echo "$status_response" | head -n -1)
          status_code=$(echo "$status_response" | tail -n 1)
          
          if [ "$status_code" -eq 200 ]; then
            echo "Status obtido com sucesso:"
            echo "$status_body" | python3 -m json.tool 2>/dev/null || echo "$status_body"
            
            # Extrair boias ativas
            active=$(echo "$status_body" | grep -o '"active":[0-9]' | grep -o '[0-9]' || echo "0")
            total=$(echo "$status_body" | grep -o '"total":[0-9]' | grep -o '[0-9]' || echo "14")
            
            echo ""
            echo "Boias ativas: $active/$total"
            
            if [ "$active" -ge 10 ]; then
              echo "Status excelente! Maioria das boias online."
            elif [ "$active" -ge 5 ]; then
              echo "Status bom! Algumas boias offline."
            else
              echo "Status degradado! Poucas boias online (pode ser normal a noite)."
            fi
          else
            echo "Nao foi possivel obter status (HTTP $status_code)"
            echo "   Sistema continuara funcionando normalmente"
          fi

name: Resumo
        if: always()  # Sempre executar
        run: |
          echo ""
          echo "============================================================"
          echo "RESUMO DA SINCRONIZACAO PNBOIA"
          echo "============================================================"
          echo "Concluido em: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Proxima execucao: $(date -u -d '+3 hours' '+%H:%M UTC')"
          echo "Frequencia: A cada 3 horas (8x por dia)"
          echo "============================================================"
          echo ""
          echo "DICAS:"
          echo "   - Para ver logs: GitHub -> Actions -> PNBOIA Auto Sync"
          echo "   - Para executar manualmente: Actions -> PNBOIA Auto Sync -> Run workflow"
          echo "   - Para pausar: Settings -> Actions -> Disable workflow"
          echo ""
```
